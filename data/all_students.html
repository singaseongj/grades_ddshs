<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>전체 학생 성적 분석</title>
  <link rel="stylesheet" href="../style.css" />
  <style>
    .analysis-container { margin-top: 20px; }
    .analysis-container h1 { margin-bottom: 10px; }
    .analysis-container .description { color: #555; margin-bottom: 25px; }

    .analysis-summary {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 20px;
    }
    .summary-item {
      background: #f0f4ff;
      border-radius: 10px;
      padding: 14px 20px;
      min-width: 160px;
      box-shadow: 0 1px 4px rgba(26, 39, 86, 0.12);
    }
    .summary-item .label {
      font-size: 14px;
      color: #5f6368;
      display: block;
      margin-bottom: 6px;
    }
    .summary-item .value {
      font-size: 20px;
      font-weight: 600;
      color: #1a237e;
    }

    .empty-state {
      text-align: center;
      background: #fff3e0;
      border-radius: 10px;
      border: 1px solid #ffe0b2;
      padding: 40px 20px;
      color: #8a6d3b;
    }
    .empty-state p { margin-bottom: 18px; font-size: 16px; }

    .link-button {
      display: inline-block;
      padding: 10px 20px;
      background-color: #1a73e8;
      color: #fff;
      border-radius: 6px;
      font-weight: 600;
      text-decoration: none;
    }
    .link-button:hover { background-color: #0c47a1; }

    .analysis-content { margin-top: 10px; }
    .grade-note { color: #5f6368; margin-bottom: 12px; }
    .grade-cell { font-weight: 600; color: #0d47a1; }
    .grade-cell span { display: block; font-size: 12px; color: #5f6368; font-weight: 400; }

    .analysis-table th {
      position: relative;
      text-align: center;
      white-space: nowrap;
      padding-right: 28px;
      vertical-align: bottom;
    }

    .analysis-table th span {
      display: block;
      font-weight: 600;
    }

    .analysis-table th .align-button {
      position: absolute;
      top: 6px;
      right: 6px;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      border: 1px solid #1a73e8;
      background: #fff;
      color: #1a73e8;
      border-radius: 50%;
      cursor: pointer;
      font-size: 14px;
      line-height: 1;
    }

    .analysis-table th .align-button:hover {
      background-color: #e8f0fe;
    }

    .weight-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 18px;
      align-items: flex-end;
    }

    .weight-controls.hidden {
      display: none;
    }

    .weight-group {
      display: flex;
      flex-direction: column;
      min-width: 130px;
    }

    .weight-group label {
      font-size: 13px;
      color: #5f6368;
      margin-bottom: 6px;
    }

    .weight-group input {
      padding: 6px 10px;
      border: 1px solid #c3c8d4;
      border-radius: 6px;
      font-size: 14px;
      width: 100%;
      box-sizing: border-box;
    }

    .grade-cut-container {
      margin-top: 32px;
    }

    .grade-cut-container h2 {
      font-size: 18px;
      margin-bottom: 12px;
      color: #1a237e;
    }

    .grade-cut-table {
      width: 100%;
      border-collapse: collapse;
      background: #f8f9ff;
      border-radius: 10px;
      overflow: hidden;
    }

    .grade-cut-table th,
    .grade-cut-table td {
      border: 1px solid #d9def2;
      padding: 10px 14px;
      text-align: center;
      font-size: 14px;
    }

    .grade-cut-table th {
      background: #e8ecff;
      color: #1a237e;
      font-weight: 600;
    }

    .grade-cut-table td:first-child {
      font-weight: 600;
      color: #1a237e;
      background: #eef1ff;
    }

    @media (max-width: 768px) {
      .summary-item { flex: 1 1 100%; }
      table { font-size: 14px; }
    }
  </style>
</head>
<body>
  <div class="container analysis-container">
    <h1>전체 학생 성적 분석</h1>
    <p class="description">업로드한 엑셀 데이터를 기반으로 학생별 가중치 합계, 가중치 평균, 과목별 등급, 전체 등수를 확인할 수 있습니다.</p>

    <div id="emptyState" class="empty-state" hidden>
      <p>아직 업로드된 학생 성적 데이터가 없습니다. 메인 화면에서 엑셀 파일을 업로드한 뒤 다시 확인해주세요.</p>
      <a class="link-button" href="../index.html">메인 화면으로 이동</a>
    </div>

    <div id="analysisContent" class="analysis-content" hidden>
      <div class="analysis-summary" id="analysisSummary"></div>
      <div id="weightControls" class="weight-controls hidden"></div>
      <p class="grade-note">※ 등급은 1~5등급 비율 (10% / 24% / 32% / 24% / 10%)을 기반으로 과목별 성적 순위를 계산하여 산출됩니다.</p>
      <table class="analysis-table">
        <thead id="analysisHead"></thead>
        <tbody id="analysisBody"></tbody>
      </table>
      <div id="gradeCutContainer" class="grade-cut-container" hidden>
        <h2>과목별 등급</h2>
        <table class="grade-cut-table">
          <thead id="gradeCutHead"></thead>
          <tbody id="gradeCutBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const SUBJECTS = ['공통국어','공통수학','공통영어','한국사','통합사회','통합과학'];
    const GRADE_CONFIG = [10, 24, 32, 24, 10];
    const GRADE_LEVELS = [1, 2, 3, 4, 5];
    const STORAGE_KEY = 'grades:studentDataset';
    let currentStudents = [];
    let currentSortKey = 'overallRank';
    let subjectWeights = SUBJECTS.map(() => 1);

    const SORT_HANDLERS = {
      overallRank: (a, b) => {
        const result = compareNumericAsc(a.overallRank, b.overallRank);
        if (result !== 0) return result;
        return a.name.localeCompare(b.name, 'ko');
      },
      name: (a, b) => {
        const result = compareStringAsc(a.name, b.name);
        if (result !== 0) return result;
        return compareStringAsc(a.studentId, b.studentId);
      },
      studentId: (a, b) => {
        const result = compareStringAsc(a.studentId, b.studentId);
        if (result !== 0) return result;
        return a.name.localeCompare(b.name, 'ko');
      },
      weightedSum: (a, b) => {
        const result = compareNumericAsc(a.weightedSum, b.weightedSum);
        if (result !== 0) return result;
        return a.name.localeCompare(b.name, 'ko');
      },
      weightedAverage: (a, b) => {
        const result = compareNumericAsc(a.weightedAverage, b.weightedAverage);
        if (result !== 0) return result;
        return a.name.localeCompare(b.name, 'ko');
      },
      averageGrade: (a, b) => {
        const result = compareNumericAsc(a.averageGradeValue, b.averageGradeValue);
        if (result !== 0) return result;
        return a.name.localeCompare(b.name, 'ko');
      }
    };

    SUBJECTS.forEach((_, index) => {
      SORT_HANDLERS[`subject-${index}`] = (a, b) => {
        const scoreCompare = compareNumericAsc(a.subjectAverages[index], b.subjectAverages[index]);
        if (scoreCompare !== 0) return scoreCompare;
        const gradeCompare = compareNumericAsc(extractGradeValue(a.subjectGrades[index]), extractGradeValue(b.subjectGrades[index]));
        if (gradeCompare !== 0) return gradeCompare;
        return a.name.localeCompare(b.name, 'ko');
      };
    });

    function loadStudentDataset() {
      if (typeof localStorage === 'undefined') return null;
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return null;
        const parsed = JSON.parse(raw);
        return parsed && typeof parsed === 'object' ? parsed : null;
      } catch (err) {
        console.error('저장된 학생 데이터를 불러오는 중 문제가 발생했습니다.', err);
        return null;
      }
    }

    function formatNumber(value, digits = 1) {
      if (!Number.isFinite(value)) return '-';
      return value.toLocaleString('ko-KR', {
        minimumFractionDigits: digits,
        maximumFractionDigits: digits
      });
    }

    function formatScoreDisplay(value) {
      if (!Number.isFinite(value)) return '-';
      const hasDecimal = Math.abs(value - Math.round(value)) > 1e-6;
      return formatNumber(value, hasDecimal ? 1 : 0);
    }

    function compareNumericAsc(rawA, rawB) {
      const a = Number.isFinite(rawA) ? rawA : Infinity;
      const b = Number.isFinite(rawB) ? rawB : Infinity;
      if (a < b) return -1;
      if (a > b) return 1;
      return 0;
    }

    function compareStringAsc(rawA, rawB) {
      const a = rawA ?? '';
      const b = rawB ?? '';
      return String(a).localeCompare(String(b), 'ko');
    }

    function extractGradeValue(gradeText) {
      if (typeof gradeText !== 'string') return null;
      const match = gradeText.match(/(\d+)/);
      return match ? Number(match[1]) : null;
    }

    function calculateSubjectAverage(student, index) {
      const terms = [student.semester1, student.semester2, student.semester3];
      const scores = [];
      terms.forEach(term => {
        if (!Array.isArray(term) || term.length <= index) return;
        const score = Number(term[index]);
        if (Number.isFinite(score)) {
          scores.push(score);
        }
      });
      if (scores.length === 0) return 0;
      const total = scores.reduce((sum, value) => sum + value, 0);
      return total / scores.length;
    }

    function buildStudentSummaries(dataset) {
      return Object.entries(dataset).map(([name, info]) => {
        const subjectAverages = SUBJECTS.map((_, idx) => calculateSubjectAverage(info, idx));
        const totalScore = subjectAverages.reduce((sum, value) => sum + value, 0);
        const averageScore = SUBJECTS.length > 0 ? totalScore / SUBJECTS.length : 0;
        return {
          key: `${name}__${info.number ?? ''}`,
          name,
          studentId: info.number ?? '',
          subjectAverages,
          subjectGrades: Array(SUBJECTS.length).fill('-'),
          sum: totalScore,
          average: averageScore,
          weightedSum: 0,
          weightedAverage: 0,
          averageGradeValue: null,
          averageGradeText: '-',
          overallRank: 0
        };
      });
    }

    function computeGradeSlices(total) {
      if (total <= 0) return [];
      const slices = [];
      let cumulativeEstimate = 0;
      let previousEnd = 0;

      GRADE_CONFIG.forEach((percent, index) => {
        cumulativeEstimate += total * (percent / 100);
        let endRank = Math.round(cumulativeEstimate);
        if (index === GRADE_CONFIG.length - 1) {
          endRank = total;
        } else {
          endRank = Math.min(endRank, total);
        }
        if (endRank < previousEnd) {
          endRank = previousEnd;
        }
        const startRank = previousEnd + 1;
        const adjustedEnd = Math.max(endRank, startRank - 1);
        slices.push({ grade: index + 1, startRank, endRank: adjustedEnd });
        previousEnd = adjustedEnd;
      });

      const lastSlice = slices[slices.length - 1];
      if (lastSlice && lastSlice.endRank < total) {
        lastSlice.endRank = total;
      }
      return slices;
    }

    function assignSubjectGrades(students) {
      if (!students.length) return;
      SUBJECTS.forEach((_, subjectIndex) => {
        const ordered = [...students].sort((a, b) => b.subjectAverages[subjectIndex] - a.subjectAverages[subjectIndex]);
        const gradeSlices = computeGradeSlices(ordered.length);
        let previousScore = null;
        let previousRank = 0;
        let previousGrade = null;

        ordered.forEach((student, index) => {
          const score = student.subjectAverages[subjectIndex];
          const isTie = previousScore !== null && Math.abs(previousScore - score) < 1e-6;
          const rank = isTie ? previousRank : index + 1;
          const slice = gradeSlices.find(range => rank >= range.startRank && rank <= range.endRank) || gradeSlices[gradeSlices.length - 1];
          const gradeValue = slice ? `${slice.grade}등급` : '-';
          student.subjectGrades[subjectIndex] = isTie && previousGrade ? previousGrade : gradeValue;
          if (!isTie) {
            previousScore = score;
            previousRank = rank;
            previousGrade = student.subjectGrades[subjectIndex];
          }
        });
      });
    }

    function assignOverallRanks(students) {
      if (!students.length) return;
      const ordered = [...students].sort((a, b) => b.weightedSum - a.weightedSum);
      let previousScore = null;
      let previousRank = 0;

      ordered.forEach((student, index) => {
        const score = student.weightedSum;
        const isTie = previousScore !== null && Math.abs(previousScore - score) < 1e-6;
        const rank = isTie ? previousRank : index + 1;
        student.overallRank = rank;
        if (!isTie) {
          previousScore = score;
          previousRank = rank;
        }
      });
    }

    function assignAverageGrades(students) {
      students.forEach(student => {
        const gradeValues = student.subjectGrades
          .map(extractGradeValue)
          .filter(value => Number.isFinite(value));
        if (!gradeValues.length) {
          student.averageGradeValue = null;
          student.averageGradeText = '-';
          return;
        }
        const total = gradeValues.reduce((sum, value) => sum + value, 0);
        const averageGrade = total / gradeValues.length;
        student.averageGradeValue = averageGrade;
        student.averageGradeText = `${formatNumber(averageGrade, 1)}등급`;
      });
    }

    function applyWeights(students) {
      if (!Array.isArray(students) || !students.length) return;
      const sanitizedWeights = subjectWeights.map(value => {
        const numeric = Number(value);
        if (!Number.isFinite(numeric) || numeric < 0) return 0;
        return numeric;
      });
      const totalWeight = sanitizedWeights.reduce((sum, value) => sum + value, 0);

      students.forEach(student => {
        const weightedSum = student.subjectAverages.reduce((sum, score, index) => {
          const weight = sanitizedWeights[index] ?? 0;
          if (!Number.isFinite(score) || !Number.isFinite(weight)) return sum;
          return sum + score * weight;
        }, 0);

        student.weightedSum = weightedSum;
        student.weightedAverage = totalWeight > 0 ? weightedSum / totalWeight : null;
      });
    }

    function calculateGradeCutlines(students) {
      if (!Array.isArray(students) || !students.length) {
        return SUBJECTS.map(() => ({}));
      }

      return SUBJECTS.map((_, subjectIndex) => {
        const ordered = [...students].sort((a, b) => b.subjectAverages[subjectIndex] - a.subjectAverages[subjectIndex]);
        const gradeSlices = computeGradeSlices(ordered.length);
        const cutlines = {};

        gradeSlices.forEach(slice => {
          const sliceStudents = ordered.slice(slice.startRank - 1, slice.endRank);
          if (!sliceStudents.length) return;
          const lowestScore = sliceStudents[sliceStudents.length - 1].subjectAverages[subjectIndex];
          cutlines[slice.grade] = lowestScore;
        });

        return cutlines;
      });
    }

    function renderGradeCutTable(students) {
      const container = document.getElementById('gradeCutContainer');
      const head = document.getElementById('gradeCutHead');
      const body = document.getElementById('gradeCutBody');
      if (!container || !head || !body) return;

      head.innerHTML = '';
      body.innerHTML = '';

      if (!students.length) {
        container.hidden = true;
        return;
      }

      const gradeCutlines = calculateGradeCutlines(students);
      const headRow = document.createElement('tr');
      const titleTh = document.createElement('th');
      titleTh.textContent = '등급컷';
      headRow.appendChild(titleTh);
      SUBJECTS.forEach(subject => {
        const th = document.createElement('th');
        th.textContent = subject;
        headRow.appendChild(th);
      });
      head.appendChild(headRow);

      GRADE_LEVELS.forEach(level => {
        const tr = document.createElement('tr');
        const gradeCell = document.createElement('td');
        gradeCell.textContent = `${level}등급`;
        tr.appendChild(gradeCell);

        SUBJECTS.forEach((_, subjectIndex) => {
          const td = document.createElement('td');
          const score = gradeCutlines[subjectIndex]?.[level];
          td.textContent = Number.isFinite(score) ? formatNumber(score, 2) : '-';
          tr.appendChild(td);
        });

        body.appendChild(tr);
      });

      container.hidden = false;
    }

    function onWeightChanged() {
      if (!currentStudents.length) return;
      applyWeights(currentStudents);
      assignOverallRanks(currentStudents);
      renderSummary(currentStudents);
      renderGradeCutTable(currentStudents);
      const targetSortKey = SORT_HANDLERS[currentSortKey] ? currentSortKey : 'overallRank';
      sortStudents(targetSortKey);
    }

    function createWeightControls() {
      const container = document.getElementById('weightControls');
      if (!container) return;

      container.innerHTML = '';
      SUBJECTS.forEach((subject, index) => {
        const group = document.createElement('div');
        group.className = 'weight-group';

        const label = document.createElement('label');
        const inputId = `weight-${index}`;
        label.setAttribute('for', inputId);
        label.textContent = `${subject} 가중치`;

        const input = document.createElement('input');
        input.type = 'number';
        input.id = inputId;
        input.min = '0';
        input.step = '0.1';
        input.value = subjectWeights[index];
        input.addEventListener('input', () => {
          const rawValue = Number(input.value);
          subjectWeights[index] = Number.isFinite(rawValue) && rawValue >= 0 ? rawValue : 0;
          onWeightChanged();
        });

        group.appendChild(label);
        group.appendChild(input);
        container.appendChild(group);
      });

      container.classList.remove('hidden');
    }

    function createHeaderCell(label, sortKey) {
      const th = document.createElement('th');
      const labelSpan = document.createElement('span');
      labelSpan.textContent = label;
      th.appendChild(labelSpan);
      const button = document.createElement('button');
      button.type = 'button';
      button.className = 'align-button';
      button.innerHTML = '<span aria-hidden="true">↕</span>';
      button.title = `${label} 정렬`;
      button.setAttribute('aria-label', `${label} 정렬`);
      button.addEventListener('click', () => sortStudents(sortKey));
      th.appendChild(button);
      return th;
    }

    function sortStudents(sortKey) {
      if (!Array.isArray(currentStudents) || currentStudents.length === 0) return;
      const key = SORT_HANDLERS[sortKey] ? sortKey : 'overallRank';
      const comparator = SORT_HANDLERS[key];
      if (typeof comparator !== 'function') return;
      currentSortKey = key;
      currentStudents.sort(comparator);
      renderTableRows(currentStudents);
    }

    function buildTableHeader() {
      const head = document.getElementById('analysisHead');
      head.innerHTML = '';
      const row = document.createElement('tr');
      const baseHeaders = [
        { label: '전체 등수', sortKey: 'overallRank' },
        { label: '이름', sortKey: 'name' },
        { label: '학번', sortKey: 'studentId' },
        { label: '가중치 합계', sortKey: 'weightedSum' },
        { label: '가중치 평균', sortKey: 'weightedAverage' },
        { label: '등급 평균', sortKey: 'averageGrade' }
      ];
      baseHeaders.forEach(({ label, sortKey }) => {
        row.appendChild(createHeaderCell(label, sortKey));
      });
      SUBJECTS.forEach((subject, index) => {
        const th = createHeaderCell(`${subject} / 등급`, `subject-${index}`);
        row.appendChild(th);
      });
      head.appendChild(row);
    }

    function renderTableRows(students) {
      const body = document.getElementById('analysisBody');
      body.innerHTML = '';
      students.forEach(student => {
        const row = document.createElement('tr');

        const rankCell = document.createElement('td');
        rankCell.textContent = student.overallRank ? `${student.overallRank}` : '-';
        row.appendChild(rankCell);

        const nameCell = document.createElement('td');
        nameCell.textContent = student.name;
        row.appendChild(nameCell);

        const idCell = document.createElement('td');
        idCell.textContent = student.studentId ? student.studentId : '-';
        row.appendChild(idCell);

        const sumCell = document.createElement('td');
        sumCell.textContent = formatNumber(student.weightedSum, 2);
        row.appendChild(sumCell);

        const avgCell = document.createElement('td');
        avgCell.textContent = formatNumber(student.weightedAverage, 2);
        row.appendChild(avgCell);

        const avgGradeCell = document.createElement('td');
        avgGradeCell.classList.add('grade-cell');
        avgGradeCell.textContent = student.averageGradeText ?? '-';
        row.appendChild(avgGradeCell);

        student.subjectGrades.forEach((grade, index) => {
          const td = document.createElement('td');
          td.classList.add('grade-cell');
          const averageScore = student.subjectAverages[index];
          const scoreText = formatScoreDisplay(averageScore);
          const gradeText = grade && grade !== '-' ? grade : '-';
          td.textContent = `${scoreText} / ${gradeText}`;
          if (Number.isFinite(averageScore)) {
            td.title = `${SUBJECTS[index]} 평균: ${formatNumber(averageScore, 1)}점`;
          }
          row.appendChild(td);
        });

        body.appendChild(row);
      });
    }

    function renderSummary(students) {
      const summary = document.getElementById('analysisSummary');
      summary.innerHTML = '';
      if (!students.length) return;
      const items = [
        { label: '총 학생 수', value: `${students.length.toLocaleString('ko-KR')}명` }
      ];

      items.forEach(({ label, value }) => {
        const wrapper = document.createElement('div');
        wrapper.className = 'summary-item';
        const labelEl = document.createElement('span');
        labelEl.className = 'label';
        labelEl.textContent = label;
        const valueEl = document.createElement('span');
        valueEl.className = 'value';
        valueEl.textContent = value;
        wrapper.appendChild(labelEl);
        wrapper.appendChild(valueEl);
        summary.appendChild(wrapper);
      });
    }

    function initialize() {
      const dataset = loadStudentDataset();
      const emptyState = document.getElementById('emptyState');
      const analysisContent = document.getElementById('analysisContent');

      if (!dataset || Object.keys(dataset).length === 0) {
        emptyState.hidden = false;
        analysisContent.hidden = true;
        return;
      }

      const students = buildStudentSummaries(dataset);
      if (!students.length) {
        emptyState.hidden = false;
        analysisContent.hidden = true;
        return;
      }

      currentStudents = students;
      subjectWeights = SUBJECTS.map(() => 1);
      assignSubjectGrades(currentStudents);
      assignAverageGrades(currentStudents);
      applyWeights(currentStudents);
      assignOverallRanks(currentStudents);
      buildTableHeader();
      renderSummary(currentStudents);
      renderGradeCutTable(currentStudents);
      createWeightControls();
      sortStudents('overallRank');

      emptyState.hidden = true;
      analysisContent.hidden = false;
    }

    document.addEventListener('DOMContentLoaded', initialize);
  </script>
</body>
</html>
