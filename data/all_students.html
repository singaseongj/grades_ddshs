<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>전체 학생 성적 분석</title>
  <link rel="stylesheet" href="../style.css" />
  <style>
    .analysis-container { margin-top: 20px; }
    .analysis-container h1 { margin-bottom: 10px; }
    .analysis-container .description { color: #555; margin-bottom: 25px; }

    .analysis-summary {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 20px;
    }
    .summary-item {
      background: #f0f4ff;
      border-radius: 10px;
      padding: 14px 20px;
      min-width: 160px;
      box-shadow: 0 1px 4px rgba(26, 39, 86, 0.12);
    }
    .summary-item .label {
      font-size: 14px;
      color: #5f6368;
      display: block;
      margin-bottom: 6px;
    }
    .summary-item .value {
      font-size: 20px;
      font-weight: 600;
      color: #1a237e;
    }

    .empty-state {
      text-align: center;
      background: #fff3e0;
      border-radius: 10px;
      border: 1px solid #ffe0b2;
      padding: 40px 20px;
      color: #8a6d3b;
    }
    .empty-state p { margin-bottom: 18px; font-size: 16px; }

    .link-button {
      display: inline-block;
      padding: 10px 20px;
      background-color: #1a73e8;
      color: #fff;
      border-radius: 6px;
      font-weight: 600;
      text-decoration: none;
    }
    .link-button:hover { background-color: #0c47a1; }

    .analysis-content { margin-top: 10px; }
    .grade-note { color: #5f6368; margin-bottom: 12px; }
    .grade-cell { font-weight: 600; color: #0d47a1; }
    .grade-cell span { display: block; font-size: 12px; color: #5f6368; font-weight: 400; }

    .analysis-table th {
      display: flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
    }

    .analysis-table th .align-button {
      margin-left: auto;
      padding: 4px 8px;
      font-size: 12px;
      border: 1px solid #1a73e8;
      background: #fff;
      color: #1a73e8;
      border-radius: 4px;
      cursor: pointer;
    }

    .analysis-table th .align-button:hover {
      background-color: #e8f0fe;
    }

    @media (max-width: 768px) {
      .summary-item { flex: 1 1 100%; }
      table { font-size: 14px; }
    }
  </style>
</head>
<body>
  <div class="container analysis-container">
    <h1>전체 학생 성적 분석</h1>
    <p class="description">업로드한 엑셀 데이터를 기반으로 학생별 합계, 평균, 과목별 등급, 전체 등수를 확인할 수 있습니다.</p>

    <div id="emptyState" class="empty-state" hidden>
      <p>아직 업로드된 학생 성적 데이터가 없습니다. 메인 화면에서 엑셀 파일을 업로드한 뒤 다시 확인해주세요.</p>
      <a class="link-button" href="../index.html">메인 화면으로 이동</a>
    </div>

    <div id="analysisContent" class="analysis-content" hidden>
      <div class="analysis-summary" id="analysisSummary"></div>
      <p class="grade-note">※ 등급은 1~5등급 비율 (10% / 24% / 32% / 24% / 10%)을 기반으로 과목별 성적 순위를 계산하여 산출됩니다.</p>
      <table class="analysis-table">
        <thead id="analysisHead"></thead>
        <tbody id="analysisBody"></tbody>
      </table>
    </div>
  </div>

  <script>
    const SUBJECTS = ['공통국어','공통수학','공통영어','한국사','통합사회','통합과학'];
    const GRADE_CONFIG = [10, 24, 32, 24, 10];
    const STORAGE_KEY = 'grades:studentDataset';
    let currentStudents = [];

    const SORT_HANDLERS = {
      overallRank: (a, b) => {
        const result = compareNumericAsc(a.overallRank, b.overallRank);
        if (result !== 0) return result;
        return a.name.localeCompare(b.name, 'ko');
      },
      name: (a, b) => {
        const result = compareStringAsc(a.name, b.name);
        if (result !== 0) return result;
        return compareStringAsc(a.studentId, b.studentId);
      },
      studentId: (a, b) => {
        const result = compareStringAsc(a.studentId, b.studentId);
        if (result !== 0) return result;
        return a.name.localeCompare(b.name, 'ko');
      },
      sum: (a, b) => {
        const result = compareNumericAsc(a.sum, b.sum);
        if (result !== 0) return result;
        return a.name.localeCompare(b.name, 'ko');
      },
      average: (a, b) => {
        const result = compareNumericAsc(a.average, b.average);
        if (result !== 0) return result;
        return a.name.localeCompare(b.name, 'ko');
      },
      averageGrade: (a, b) => {
        const result = compareNumericAsc(a.averageGradeValue, b.averageGradeValue);
        if (result !== 0) return result;
        return a.name.localeCompare(b.name, 'ko');
      }
    };

    SUBJECTS.forEach((_, index) => {
      SORT_HANDLERS[`subject-${index}`] = (a, b) => {
        const scoreCompare = compareNumericAsc(a.subjectAverages[index], b.subjectAverages[index]);
        if (scoreCompare !== 0) return scoreCompare;
        const gradeCompare = compareNumericAsc(extractGradeValue(a.subjectGrades[index]), extractGradeValue(b.subjectGrades[index]));
        if (gradeCompare !== 0) return gradeCompare;
        return a.name.localeCompare(b.name, 'ko');
      };
    });

    function loadStudentDataset() {
      if (typeof localStorage === 'undefined') return null;
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return null;
        const parsed = JSON.parse(raw);
        return parsed && typeof parsed === 'object' ? parsed : null;
      } catch (err) {
        console.error('저장된 학생 데이터를 불러오는 중 문제가 발생했습니다.', err);
        return null;
      }
    }

    function formatNumber(value, digits = 1) {
      if (!Number.isFinite(value)) return '-';
      return value.toLocaleString('ko-KR', {
        minimumFractionDigits: digits,
        maximumFractionDigits: digits
      });
    }

    function formatScoreDisplay(value) {
      if (!Number.isFinite(value)) return '-';
      const hasDecimal = Math.abs(value - Math.round(value)) > 1e-6;
      return formatNumber(value, hasDecimal ? 1 : 0);
    }

    function compareNumericAsc(rawA, rawB) {
      const a = Number.isFinite(rawA) ? rawA : Infinity;
      const b = Number.isFinite(rawB) ? rawB : Infinity;
      if (a < b) return -1;
      if (a > b) return 1;
      return 0;
    }

    function compareStringAsc(rawA, rawB) {
      const a = rawA ?? '';
      const b = rawB ?? '';
      return String(a).localeCompare(String(b), 'ko');
    }

    function extractGradeValue(gradeText) {
      if (typeof gradeText !== 'string') return null;
      const match = gradeText.match(/(\d+)/);
      return match ? Number(match[1]) : null;
    }

    function calculateSubjectAverage(student, index) {
      const terms = [student.semester1, student.semester2, student.semester3];
      const scores = [];
      terms.forEach(term => {
        if (!Array.isArray(term) || term.length <= index) return;
        const score = Number(term[index]);
        if (Number.isFinite(score)) {
          scores.push(score);
        }
      });
      if (scores.length === 0) return 0;
      const total = scores.reduce((sum, value) => sum + value, 0);
      return total / scores.length;
    }

    function buildStudentSummaries(dataset) {
      return Object.entries(dataset).map(([name, info]) => {
        const subjectAverages = SUBJECTS.map((_, idx) => calculateSubjectAverage(info, idx));
        const totalScore = subjectAverages.reduce((sum, value) => sum + value, 0);
        const averageScore = SUBJECTS.length > 0 ? totalScore / SUBJECTS.length : 0;
        return {
          key: `${name}__${info.number ?? ''}`,
          name,
          studentId: info.number ?? '',
          subjectAverages,
          subjectGrades: Array(SUBJECTS.length).fill('-'),
          sum: totalScore,
          average: averageScore,
          averageGradeValue: null,
          averageGradeText: '-',
          overallRank: 0
        };
      });
    }

    function computeGradeSlices(total) {
      if (total <= 0) return [];
      const slices = [];
      let cumulativeEstimate = 0;
      let previousEnd = 0;

      GRADE_CONFIG.forEach((percent, index) => {
        cumulativeEstimate += total * (percent / 100);
        let endRank = Math.round(cumulativeEstimate);
        if (index === GRADE_CONFIG.length - 1) {
          endRank = total;
        } else {
          endRank = Math.min(endRank, total);
        }
        if (endRank < previousEnd) {
          endRank = previousEnd;
        }
        const startRank = previousEnd + 1;
        const adjustedEnd = Math.max(endRank, startRank - 1);
        slices.push({ grade: index + 1, startRank, endRank: adjustedEnd });
        previousEnd = adjustedEnd;
      });

      const lastSlice = slices[slices.length - 1];
      if (lastSlice && lastSlice.endRank < total) {
        lastSlice.endRank = total;
      }
      return slices;
    }

    function assignSubjectGrades(students) {
      if (!students.length) return;
      SUBJECTS.forEach((_, subjectIndex) => {
        const ordered = [...students].sort((a, b) => b.subjectAverages[subjectIndex] - a.subjectAverages[subjectIndex]);
        const gradeSlices = computeGradeSlices(ordered.length);
        let previousScore = null;
        let previousRank = 0;
        let previousGrade = null;

        ordered.forEach((student, index) => {
          const score = student.subjectAverages[subjectIndex];
          const isTie = previousScore !== null && Math.abs(previousScore - score) < 1e-6;
          const rank = isTie ? previousRank : index + 1;
          const slice = gradeSlices.find(range => rank >= range.startRank && rank <= range.endRank) || gradeSlices[gradeSlices.length - 1];
          const gradeValue = slice ? `${slice.grade}등급` : '-';
          student.subjectGrades[subjectIndex] = isTie && previousGrade ? previousGrade : gradeValue;
          if (!isTie) {
            previousScore = score;
            previousRank = rank;
            previousGrade = student.subjectGrades[subjectIndex];
          }
        });
      });
    }

    function assignOverallRanks(students) {
      if (!students.length) return;
      const ordered = [...students].sort((a, b) => b.sum - a.sum);
      let previousScore = null;
      let previousRank = 0;

      ordered.forEach((student, index) => {
        const score = student.sum;
        const isTie = previousScore !== null && Math.abs(previousScore - score) < 1e-6;
        const rank = isTie ? previousRank : index + 1;
        student.overallRank = rank;
        if (!isTie) {
          previousScore = score;
          previousRank = rank;
        }
      });
    }

    function assignAverageGrades(students) {
      students.forEach(student => {
        const gradeValues = student.subjectGrades
          .map(extractGradeValue)
          .filter(value => Number.isFinite(value));
        if (!gradeValues.length) {
          student.averageGradeValue = null;
          student.averageGradeText = '-';
          return;
        }
        const total = gradeValues.reduce((sum, value) => sum + value, 0);
        const averageGrade = total / gradeValues.length;
        student.averageGradeValue = averageGrade;
        student.averageGradeText = `${formatNumber(averageGrade, 1)}등급`;
      });
    }

    function createHeaderCell(label, sortKey) {
      const th = document.createElement('th');
      const labelSpan = document.createElement('span');
      labelSpan.textContent = label;
      th.appendChild(labelSpan);
      const button = document.createElement('button');
      button.type = 'button';
      button.className = 'align-button';
      button.textContent = 'A→Z';
      button.title = `${label} 정렬`;
      button.setAttribute('aria-label', `${label} 정렬`);
      button.addEventListener('click', () => sortStudents(sortKey));
      th.appendChild(button);
      return th;
    }

    function sortStudents(sortKey) {
      if (!Array.isArray(currentStudents) || currentStudents.length === 0) return;
      const comparator = SORT_HANDLERS[sortKey];
      if (typeof comparator !== 'function') return;
      currentStudents.sort(comparator);
      renderTableRows(currentStudents);
    }

    function buildTableHeader() {
      const head = document.getElementById('analysisHead');
      head.innerHTML = '';
      const row = document.createElement('tr');
      const baseHeaders = [
        { label: '전체 등수', sortKey: 'overallRank' },
        { label: '이름', sortKey: 'name' },
        { label: '학번', sortKey: 'studentId' },
        { label: '합계', sortKey: 'sum' },
        { label: '평균', sortKey: 'average' },
        { label: '등급 평균', sortKey: 'averageGrade' }
      ];
      baseHeaders.forEach(({ label, sortKey }) => {
        row.appendChild(createHeaderCell(label, sortKey));
      });
      SUBJECTS.forEach((subject, index) => {
        const th = createHeaderCell(`${subject} / 등급`, `subject-${index}`);
        row.appendChild(th);
      });
      head.appendChild(row);
    }

    function renderTableRows(students) {
      const body = document.getElementById('analysisBody');
      body.innerHTML = '';
      students.forEach(student => {
        const row = document.createElement('tr');

        const rankCell = document.createElement('td');
        rankCell.textContent = student.overallRank ? `${student.overallRank}` : '-';
        row.appendChild(rankCell);

        const nameCell = document.createElement('td');
        nameCell.textContent = student.name;
        row.appendChild(nameCell);

        const idCell = document.createElement('td');
        idCell.textContent = student.studentId ? student.studentId : '-';
        row.appendChild(idCell);

        const sumCell = document.createElement('td');
        sumCell.textContent = formatNumber(student.sum, 1);
        row.appendChild(sumCell);

        const avgCell = document.createElement('td');
        avgCell.textContent = formatNumber(student.average, 2);
        row.appendChild(avgCell);

        const avgGradeCell = document.createElement('td');
        avgGradeCell.classList.add('grade-cell');
        avgGradeCell.textContent = student.averageGradeText ?? '-';
        row.appendChild(avgGradeCell);

        student.subjectGrades.forEach((grade, index) => {
          const td = document.createElement('td');
          td.classList.add('grade-cell');
          const averageScore = student.subjectAverages[index];
          const scoreText = formatScoreDisplay(averageScore);
          const gradeText = grade && grade !== '-' ? grade : '-';
          td.textContent = `${scoreText} / ${gradeText}`;
          if (Number.isFinite(averageScore)) {
            td.title = `${SUBJECTS[index]} 평균: ${formatNumber(averageScore, 1)}점`;
          }
          row.appendChild(td);
        });

        body.appendChild(row);
      });
    }

    function renderSummary(students) {
      const summary = document.getElementById('analysisSummary');
      summary.innerHTML = '';
      if (!students.length) return;
      const overallAverage = students.reduce((sum, student) => sum + student.average, 0) / students.length;
      const highestAverage = students.reduce((max, student) => Math.max(max, student.average), 0);

      const items = [
        { label: '총 학생 수', value: `${students.length.toLocaleString('ko-KR')}명` },
        { label: '전체 평균', value: `${formatNumber(overallAverage, 2)}점` },
        { label: '최고 평균', value: `${formatNumber(highestAverage, 2)}점` }
      ];

      items.forEach(({ label, value }) => {
        const wrapper = document.createElement('div');
        wrapper.className = 'summary-item';
        const labelEl = document.createElement('span');
        labelEl.className = 'label';
        labelEl.textContent = label;
        const valueEl = document.createElement('span');
        valueEl.className = 'value';
        valueEl.textContent = value;
        wrapper.appendChild(labelEl);
        wrapper.appendChild(valueEl);
        summary.appendChild(wrapper);
      });
    }

    function initialize() {
      const dataset = loadStudentDataset();
      const emptyState = document.getElementById('emptyState');
      const analysisContent = document.getElementById('analysisContent');

      if (!dataset || Object.keys(dataset).length === 0) {
        emptyState.hidden = false;
        analysisContent.hidden = true;
        return;
      }

      const students = buildStudentSummaries(dataset);
      if (!students.length) {
        emptyState.hidden = false;
        analysisContent.hidden = true;
        return;
      }

      assignSubjectGrades(students);
      assignAverageGrades(students);
      assignOverallRanks(students);
      buildTableHeader();
      renderSummary(students);
      currentStudents = [...students];
      sortStudents('overallRank');

      emptyState.hidden = true;
      analysisContent.hidden = false;
    }

    document.addEventListener('DOMContentLoaded', initialize);
  </script>
</body>
</html>
